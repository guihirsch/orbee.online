<!doctype html>
<html lang="pt-BR">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Validador de GeoTIFF - NDVI</title>
      <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.js"></script>
      <style>
         body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
         }
         .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
         }
         .drop-zone {
            border: 3px dashed #007acc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
         }
         .drop-zone:hover {
            background: #e3f2fd;
            border-color: #0056b3;
         }
         .drop-zone.dragover {
            background: #e3f2fd;
            border-color: #0056b3;
         }
         .results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007acc;
         }
         .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
         }
         .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
         }
         .stat-label {
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
         }
         .stat-value {
            font-size: 1.2em;
            color: #007acc;
            margin-top: 5px;
         }
         .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
         }
         .success {
            color: #2e7d32;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2e7d32;
         }
         .histogram {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
         }
         canvas {
            max-width: 100%;
            height: 200px;
         }
      </style>
   </head>
   <body>
      <div class="container">
         <h1>üîç Validador de GeoTIFF - NDVI</h1>
         <p>
            Arraste seu arquivo <code>.tif</code> aqui para validar e analisar:
         </p>

         <div class="drop-zone" id="dropZone">
            <div>
               üìÅ Arraste o arquivo TIF aqui<br />
               ou clique para selecionar
            </div>
            <input
               type="file"
               id="fileInput"
               accept=".tif,.tiff"
               style="display: none"
            />
         </div>

         <div id="results"></div>
      </div>

      <script>
         const dropZone = document.getElementById("dropZone");
         const fileInput = document.getElementById("fileInput");
         const results = document.getElementById("results");

         // Drag & Drop
         dropZone.addEventListener("click", () => fileInput.click());
         dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("dragover");
         });
         dropZone.addEventListener("dragleave", () => {
            dropZone.classList.remove("dragover");
         });
         dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.classList.remove("dragover");
            const files = e.dataTransfer.files;
            if (files.length > 0) {
               processFile(files[0]);
            }
         });
         fileInput.addEventListener("change", (e) => {
            if (e.target.files.length > 0) {
               processFile(e.target.files[0]);
            }
         });

         async function processFile(file) {
            results.innerHTML =
               '<div class="success">üîÑ Processando arquivo...</div>';

            try {
               const arrayBuffer = await file.arrayBuffer();
               const tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
               const image = await tiff.getImage();

               // Metadados b√°sicos
               const width = image.getWidth();
               const height = image.getHeight();
               const samplesPerPixel = image.getSamplesPerPixel();
               const bbox = image.getBoundingBox();
               const geoKeys = image.getGeoKeys();
               const noData = image.getGDALNoData();

               // Ler dados
               const data = await image.readRasters({ interleave: true });
               const values = Array.from(data);

               // Filtrar valores v√°lidos
               const validValues = values.filter(
                  (v) => v !== noData && v !== -9999 && Number.isFinite(v)
               );

               // Estat√≠sticas
               const min = Math.min(...validValues);
               const max = Math.max(...validValues);
               const mean =
                  validValues.reduce((a, b) => a + b, 0) / validValues.length;
               const validPercent = (validValues.length / values.length) * 100;

               // CRS
               const epsg =
                  geoKeys.ProjectedCSTypeGeoKey ||
                  geoKeys.GeographicTypeGeoKey ||
                  "Desconhecido";

               // Gerar relat√≥rio
               results.innerHTML = `
                    <div class="success">‚úÖ Arquivo TIF v√°lido!</div>
                    
                    <div class="results">
                        <h3>üìä Informa√ß√µes do Arquivo</h3>
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-label">Nome do Arquivo</div>
                                <div class="stat-value">${file.name}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Tamanho</div>
                                <div class="stat-value">${(file.size / 1024).toFixed(1)} KB</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Dimens√µes</div>
                                <div class="stat-value">${width} √ó ${height}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total de Pixels</div>
                                <div class="stat-value">${(width * height).toLocaleString()}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Bandas</div>
                                <div class="stat-value">${samplesPerPixel}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">CRS (EPSG)</div>
                                <div class="stat-value">${epsg}</div>
                            </div>
                        </div>
                        
                        <h3>üéØ Estat√≠sticas NDVI</h3>
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-label">Valor M√≠nimo</div>
                                <div class="stat-value">${min.toFixed(4)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Valor M√°ximo</div>
                                <div class="stat-value">${max.toFixed(4)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">M√©dia</div>
                                <div class="stat-value">${mean.toFixed(4)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Pixels V√°lidos</div>
                                <div class="stat-value">${validPercent.toFixed(1)}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">NoData</div>
                                <div class="stat-value">${noData || "N√£o definido"}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Range</div>
                                <div class="stat-value">${(max - min).toFixed(4)}</div>
                            </div>
                        </div>
                        
                        <h3>üåç Coordenadas (Bounding Box)</h3>
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-label">Oeste (X Min)</div>
                                <div class="stat-value">${bbox[0].toFixed(6)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Sul (Y Min)</div>
                                <div class="stat-value">${bbox[1].toFixed(6)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Leste (X Max)</div>
                                <div class="stat-value">${bbox[2].toFixed(6)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Norte (Y Max)</div>
                                <div class="stat-value">${bbox[3].toFixed(6)}</div>
                            </div>
                        </div>
                        
                        <div class="histogram">
                            <h3>üìà Histograma de Valores</h3>
                            <canvas id="histogramCanvas"></canvas>
                        </div>
                    </div>
                `;

               // Gerar histograma
               generateHistogram(validValues);
            } catch (error) {
               results.innerHTML = `
                    <div class="error">
                        ‚ùå Erro ao processar arquivo:<br>
                        ${error.message}
                    </div>
                `;
            }
         }

         function generateHistogram(values) {
            const canvas = document.getElementById("histogramCanvas");
            const ctx = canvas.getContext("2d");

            // Configurar canvas
            canvas.width = 800;
            canvas.height = 200;

            // Calcular bins
            const min = Math.min(...values);
            const max = Math.max(...values);
            const bins = 50;
            const binSize = (max - min) / bins;
            const histogram = new Array(bins).fill(0);

            // Preencher histogram
            values.forEach((value) => {
               const binIndex = Math.min(
                  Math.floor((value - min) / binSize),
                  bins - 1
               );
               histogram[binIndex]++;
            });

            // Desenhar
            const maxCount = Math.max(...histogram);
            const barWidth = canvas.width / bins;

            ctx.fillStyle = "#007acc";
            histogram.forEach((count, i) => {
               const barHeight = (count / maxCount) * (canvas.height - 40);
               ctx.fillRect(
                  i * barWidth,
                  canvas.height - barHeight - 20,
                  barWidth - 1,
                  barHeight
               );
            });

            // Labels
            ctx.fillStyle = "#333";
            ctx.font = "12px Arial";
            ctx.fillText(min.toFixed(3), 5, canvas.height - 5);
            ctx.fillText(max.toFixed(3), canvas.width - 50, canvas.height - 5);
         }
      </script>
   </body>
</html>
